<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Daily General Report Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #333;
        }
        h2 {
            text-align: center;
            color: #1e88e5;
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        form {
            max-width: 400px;
            margin: 0 auto 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        button:hover {
            background: #1e88e5;
        }
        #dashboard {
            max-width: 1200px;
            margin: 0 auto;
        }
        #header {
            text-align: center;
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #1e88e5;
            font-weight: bold;
        }
        #metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .metric-card h4 {
            margin: 0 0 10px;
            color: #333;
            font-size: 1em;
        }
        .metric-card p {
            margin: 5px 0;
            font-size: 1.1em;
            color: #1e88e5;
            font-weight: bold;
        }
        .metric-card small {
            display: block;
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
        }
        #charts {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: fadeIn 0.5s ease-in;
        }
        .chart-container:hover {
            transform: translateY(-5px);
            transition: transform 0.3s;
        }
        .chart-container h3 {
            margin: 0 0 15px;
            text-align: center;
            color: #333;
            font-size: 1.2em;
        }
        #summary-table {
            margin-top: 40px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #f5f5f5;
            color: #333;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background: #fafafa;
        }
        #export-csv {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }
        #export-csv:hover {
            background: #45a049;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>Daily General Report Dashboard</h2>
    <form id="filterForm">
        <label for="academic_year">Academic Year:</label>
        <select id="academic_year" name="academic_year" required>
            <option value="2025-26" {% if academic_year == '2025-26' %}selected{% endif %}>2025-26</option>
            <option value="2024-25" {% if academic_year == '2024-25' %}selected{% endif %}>2024-25</option>
            <option value="2023-24" {% if academic_year == '2023-24' %}selected{% endif %}>2023-24</option>
            <!-- Add more years as needed -->
        </select>
        <!-- If you have a date filter, add it below -->
        <label for="date">Date (YYYY-MM-DD):</label>
        <input type="date" id="date" name="date">
        <button type="submit">Show Data</button>
    </form>
    <div id="dashboard">
        <div id="header"></div>
        <div id="metrics"></div>
        <div id="charts"></div>
        <div id="summary-table"></div>
        <a id="export-csv" style="display: none;">Export Data as CSV</a>
    </div>
    <div id="result"></div>

    <script>
        let allData = [];
        document.getElementById('filterForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const academicYear = document.getElementById('academic_year').value;
            const date = document.getElementById('date') ? document.getElementById('date').value : '';
            let url = `/show?academic_year=${academicYear}`;
            if (date) url += `&date=${date}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const resultDiv = document.getElementById('result');
                const dashboard = document.getElementById('dashboard');
                const header = document.getElementById('header');
                const metricsDiv = document.getElementById('metrics');
                const chartsDiv = document.getElementById('charts');
                const summaryTableDiv = document.getElementById('summary-table');
                const exportCsv = document.getElementById('export-csv');
                
                chartsDiv.innerHTML = '';
                metricsDiv.innerHTML = '';
                summaryTableDiv.innerHTML = '';
                resultDiv.innerHTML = '';
                exportCsv.style.display = 'none';

                if (data.error) {
                    resultDiv.innerHTML = `<p>${data.error}</p>`;
                    dashboard.style.display = 'none';
                } else {
                    dashboard.style.display = 'block';
                    header.innerHTML = `Daily General Information for Academic Year: <b>${academicYear}</b>${date ? ' | Date: <b>' + date + '</b>' : ''}`;
                    allData = data;

                    const parameters = [
                        'strength', 'onroll', 'present', 'absent', 'nso', 'paid', 'unpaid', 
                        'admission', 'tc', 'cheques', 'using_bus', 'using_rickshaw', 
                        'using_cycle_moped_stand', 'conc_50', 'conc_40', 'conc_30', 
                        'conc_20', 'conc_10', 'tw', 'mw', 'sec', 'avg_std_sec'
                    ];
                    const displayNames = [
                        'Strength', 'OnRoll', 'Present', 'Absent', 'NSO', 'Paid', 'Unpaid', 
                        'Admission', 'TC', 'Cheques', 'Using Bus', 'Using Rickshaw', 
                        'Using Cycle/Moped Stand', 'Conces. 50%', 'Conces. 40%', 'Conces. 30%', 
                        'Conces. 20%', 'Conces. 10%', "Teacher's Wards", 'Menial Ward', 
                        'Sections', 'Avg. Student Per Section'
                    ];

                    // Unique color generator
                    function generateColors(count) {
                        return Array.from({length: count}, (_, i) => `hsl(${i * 360 / count}, 70%, 55%)`);
                    }

                    // KPI Cards
                    parameters.forEach((param, index) => {
                        const total = data.reduce((sum, row) => sum + (row[param] || 0), 0);
                        const avg = data.length ? (total / data.length).toFixed(1) : 0;
                        let highestCampus = "";
                        let highestValue = -Infinity;

                        data.forEach(row => {
                            if ((row[param] || 0) > highestValue) {
                                highestValue = row[param];
                                highestCampus = row.campus_name;
                            }
                        });

                        const card = document.createElement('div');
                        card.className = 'metric-card';
                        card.innerHTML = `
                            <h4>${displayNames[index]}</h4>
                            <p>Total: ${total}</p>
                            <p>Avg: ${avg}</p>
                            <p style="color:#1e88e5; font-weight:bold;">Highest: ${highestCampus} (${highestValue})</p>
                        `;
                        metricsDiv.appendChild(card);
                    });

                    // Charts
                    parameters.forEach((param, index) => {
                        let values = data.map(row => row[param] || 0);
                        let campusNames = data.map(row => row.campus_name);
                        const total = values.reduce((sum, val) => sum + val, 0);

                        // sort descending
                        const combined = campusNames.map((campus, i) => ({campus, value: values[i]}));
                        combined.sort((a, b) => b.value - a.value);
                        campusNames = combined.map(c => c.campus);
                        values = combined.map(c => c.value);

                        const colors = generateColors(campusNames.length);

                        const canvasId = `chart-${param}`;
                        const container = document.createElement('div');
                        container.className = 'chart-container';
                        container.innerHTML = `
                            <h3>${displayNames[index]}</h3>
                            <canvas id="${canvasId}"></canvas>
                        `;
                        chartsDiv.appendChild(container);

                        const ctx = document.getElementById(canvasId).getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: campusNames,
                                datasets: [{
                                    label: displayNames[index],
                                    data: values,
                                    backgroundColor: colors,
                                    borderColor: colors,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: { beginAtZero: true, ticks: { precision: 0 } },
                                    x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
                                },
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { 
                                        callbacks: {
                                            label: function(context) {
                                                const value = context.raw;
                                                const percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                                                return `${context.dataset.label}: ${value} (${percentage}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    });

                    // Summary table
                    let table = '<h3>Summary Table</h3><table><thead><tr><th>Campus Name</th>';
                    displayNames.forEach(name => table += `<th>${name}</th>`);
                    table += '</tr></thead><tbody>';
                    data.forEach(row => {
                        table += '<tr><td>' + row.campus_name + '</td>';
                        parameters.forEach(param => table += `<td>${row[param] || ''}</td>`);
                        table += '</tr>';
                    });
                    table += '</tbody></table>';
                    summaryTableDiv.innerHTML = table;

                    exportCsv.style.display = 'block';
                    exportCsv.onclick = function() {
                        const headers = ['Campus Name', ...displayNames];
                        const csvRows = [headers.join(',')];
                        data.forEach(row => {
                            const values = [row.campus_name, ...parameters.map(param => row[param] || '')];
                            csvRows.push(values.join(','));
                        });
                        const csv = csvRows.join('\n');
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `data_${academicYear}.csv`;
                        a.click();
                        URL.revokeObjectURL(url);
                    };
                }
            } catch (error) {
                console.error('Frontend error:', error);
                document.getElementById('result').innerHTML = `<p>Error fetching data: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>